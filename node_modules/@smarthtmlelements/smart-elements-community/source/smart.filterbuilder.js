
/* Smart HTML Elements v4.6.0 (2019-Oct) 
Copyright (c) 2011-2019 jQWidgets. 
License: https://htmlelements.com/license/ */

Smart("smart-filter-builder",class extends Smart.BaseElement{static get properties(){return{customOperations:{value:[],type:"array",reflectToAttribute:!1},disableContextMenu:{value:!1,type:"boolean"},fields:{value:null,type:"array?",reflectToAttribute:!1},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},hint:{value:null,type:"string?"},icons:{value:{"=":"=","<>":"\u2260",">":">",">=":"\u2265","<":"<","<=":"\u2264",startswith:"a|bc",endswith:"ab|c",contains:"abc",notcontains:"!abc",isblank:"\u25CB",isnotblank:"\u25CF"},type:"object",reflectToAttribute:!1},maxConditions:{value:null,type:"number?",validator:"_maxValidator"},maxConditionsPerGroup:{value:null,type:"number?",validator:"_maxValidator"},maxLevel:{value:null,type:"number?",validator:"_maxValidator"},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:"{{elementType}}: Wrong parent group index in \"{{method}}\" method.",missingFields:"{{elementType}}: Fields are required for proper condition's adding. Set \"fields\" source and then conditions will be added as expected.",wrongElementNode:"{{elementType}}: Incorect node / node Id in \"{{method}}\" method.",invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME"}},type:"object",extend:!0},restrictedMode:{value:!1,type:"boolean"},showIcons:{value:!1,type:"boolean"},value:{value:["or"],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"&lt;enter a value&gt;",type:"string"}}}static get requires(){return{"Smart.Button":"smart.button.js","Smart.CheckBox":"smart.checkbox.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.ListBox":"smart.listbox.js","Smart.DropDownList":"smart.dropdownlist.js","Smart.ComboBox":"smart.combobox.js","Smart.Calendar":"smart.calendar.js","Smart.TimePicker":"smart.timepicker.js","Smart.Tooltip":"smart.tooltip.js","Smart.Utilities.DateTime":"smart.date.js","Smart.DateTimePicker":"smart.datetimepicker.js","Smart.Menu":"smart.menu.js"}}static get listeners(){return{down:"_downHandler","document.click":"_documentClickHandler","conditionsMenu.itemClick":"_menuItemClickHandler","container.change":"_containerChangeHandler","scrollableContainer.wheel":"_scrollViewerWheelHandler","scrollableOuterContainer.resize":"_resizeHandler","innerContainer.keydown":"_innerContainerKeydownHandler"}}static get styleUrls(){return["smart.filterbuilder.css"]}template(){return`<div id="container" title="[[hint]]">
                    <div id="innerContainer" class ="smart-inner-container">
                            <div id="scrollableOuterContainer" class ="smart-scrollable-outer-container">
                                <smart-scroll-viewer id="scrollableContainer" class ="smart-scrollable-container" animation="[[animation]]">
                                    <div id="contentContainer" class ="smart-content-container"></div>
                                </smart-scroll-viewer>
                            </div>
                            <div id="editorsContainer" class ="smart-editors-container">
                                <div id="customEditor" class ="smart-custom-editor smart-hidden"></div>
                            </div>
                    </div>
                    <smart-menu id="conditionsMenu" mode="dropDown" class ="smart-conditions-menu" theme="[[theme]]" animation="[[animation]]"></smart-menu>
            </div>`}propertyChangedHandler(e,t,a){const i=this;switch(super.propertyChangedHandler(e,t,a),e){case"animation":case"theme":["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"].forEach(t=>i.$[t]&&(i.$[t][e]=a));break;case"customOperations":i._handleCustomOperations(),i._refresh();break;case"fields":i._mapFieldsToMenu(),i._refresh();break;case"formatStringDate":case"formatStringDateTime":case"showIcons":case"valueFormatFunction":i._refresh();break;case"locale":case"messages":i._localizeInitialValues(),i._refresh(),i._handleCustomOperations(),i.$.dateTimePickerEditor&&(!i.$.dateTimePickerEditor.messages[i.locale]&&(i.$.dateTimePickerEditor.messages[i.locale]={}),i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel=i.localize("dateTabLabel"),i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel=i.localize("timeTabLabel"),"locale"===e?i.$.dateTimePickerEditor.locale=i.locale:"messages"==e&&(i.$.dateTimePickerEditor.$.selectDate.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel,i.$.dateTimePickerEditor.$.selectTime.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel));break;case"maxConditions":case"maxConditionsPerGroup":case"maxLevel":case"value":{i._totalConditions=0,i._validateValue(),i._emptyElementsStructure(!0),i._convertValueToFlat(i.value),i._getFieldsFromValue(),i._mapFieldsToMenu(),i._generateHTMLStructureFromFlatValue(),i.$.scrollableContainer.refresh();const e=JSON.stringify(i.value);i._oldValueAsString!==e&&(i._oldValueAsString=e,i.$.fireEvent("change",{value:JSON.parse(e)}));break}case"valuePlaceholder":i._updatePlaceholder();}}_maxValidator(e,t){return"number"==typeof t?Math.max(1,t):t}ready(){super.ready();const e=this;e._validateValue(),e._setInitialValues(),e._handleCustomOperations(),e._emptyElementsStructure(!0),e._totalConditions=0,e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._generateHTMLStructureFromFlatValue(),e.$.conditionsMenu._noAutoFocus=!0,e._oldValueAsString=JSON.stringify(e.value),e.$.scrollableContainer.refresh()}addCondition(e,t){const a=this;a._checkFieldsExistence(),a._addElement("condition",e,t)}addGroup(e,t){const a=this;a._addElement("group",e,t)}removeCondition(e){const t=this;t._validateNode(e,"removeCondition"),t._deleteElement(e,"condition"),t._refresh()}removeGroup(e){const t=this;t._validateNode(e,"removeGroup"),t._deleteElement(e,"group"),t._refresh()}toString(e){const t=this;if(!e)return JSON.stringify(t.value);let a=[],l=[];for(let l=0;l<t._valueFlat.length;l++){const e=t._valueFlat[l];let i={};if("condition"===e.type){const a=t._getFieldByFieldName(e.data[0]),l=a.dataType,o="["+(a.label||a.value)+"]",n=t.localize(e.data[1]),r=-1===["boolean","number"].indexOf(l)?"'"+e.data[2]+"'":e.data[2]+"";i.data=o+" "+n+" "+r}else i.data=e.data;i.nodeId=e.nodeId,i.parentId=e.parentId,i.type=e.type,a.push(i)}for(let o=0;o<a.length;o++){const e=a[o];let i={};if("group"===e.type){const o=a.filter(t=>t.parentId===e.nodeId&&"condition"===t.type);if(0<o.length){let a=o.map(e=>e.data),n="",r="",d=e.data;-1!==["notand","notor"].indexOf(d)&&(n="Not (",r=")",d=d.substring(3)),i.nodeId=e.nodeId,i.parentId=e.parentId,i.data=e.data,i.structure=n+a.join(" "+t.localize(d)+" ")+r,l.push(i)}}}l=l.filter(e=>1<e.structure.length),l.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(let a=0;a<l.length;a++){const e=l[a],i=l.filter(t=>t.nodeId===e.parentId)[0];if(i&&i.structure){let a=i.data;-1===["notand","notor"].indexOf(a)?i.structure=i.structure+" "+t.localize(a)+" ("+e.structure+")":(a=a.substring(3),i.structure=i.structure.slice(0,i.structure.length-1)+" "+t.localize(a)+" ("+e.structure+"))")}}return l[l.length-1].structure}updateCondition(e,t){const a=this,i=a._validateNode(e,"updateCondition");a._validateUserData(t,!0),i.data=t,a._refresh()}updateGroup(e,t){const a=this,i=a._validateNode(e,"updateGroup");a._validateUserData(t),i.data=t,a._refresh()}_addElement(e,t,a){t=t||"0";const i=this,l=i._valueFlat.filter(e=>e.nodeId===t&&"group"===e.type),o=!!(0<l.length)&&l[0],n=i._valueFlat.filter(e=>e.parentId===t);let r=0,d="";if(o||i.error(i.localize("wrongParentGroupIndex",{elementType:i.nodeName.toLowerCase(),method:"addGroup/addCondition"})),"group"===e)a=a||"or";else{if(n.filter(e=>"condition"===e.type).length===i.maxConditionsPerGroup||i._totalConditions===i.maxConditions)return;const e=i.fields&&0<i.fields.length?i.fields[0].dataField:i._valueFields[0].dataField;i._totalConditions++,a=a||[],a[0]=a[0]||e,a[1]=a[1]||"=",a[2]=void 0===typeof a[2]?null:a[2]}if(n){let e=n.map(e=>{const t=e.nodeId.split(".");return parseInt(t[t.length-1])});e=0===e.length?[0]:e,r=e.reduce(function(e,t){return Math.max(e,t)})+1}t&&0<t.length&&(d=".");const s=t+d+r,u={nodeId:s,parentId:t,type:e,data:a,htmlNode:null};i._valueFlat.push(u),i._refresh()}_clearConditionsValue(e,t){const a=this,i=(a.shadowRoot||a).querySelector("[node-id=\""+(e||0)+"\"]"),l=i.querySelector(".smart-value-container");for(let l=0;l<a._valueFlat.length;l++)if(a._valueFlat[l].nodeId===e){const e=a._valueFlat[l],i=t?a.fields.find(e=>e.dataField===t).dataType:a.fields.find(t=>t.dataField===e.data[0]).dataType;e.data[2]=a._defaultValueByType(i)}l.innerHTML=a.valuePlaceholder,l.closest(".smart-filter-value").setAttribute("placeholder","")}_convertValueToFlat(e,t){const a=this,i=/^(and|or|notAnd|notOr)$/i;if(!e)return;const l=e.filter(e=>"string"==typeof e&&e.match(i)),o=l?l[0]:null,n=e.filter(e=>Array.isArray(e)&&3===e.length&&0===e.filter(e=>"string"==typeof e&&e.match(i)).length),r=e.filter(e=>!n.includes(e)&&e!==o);if(l){const e=a._lastProcessedItemInCurrentGroup.parentId?".":"",l=(a._lastProcessedItemInCurrentGroup.parentId||"")+e+(t||0);if(!a._isMaxLevelExceeded(l)){const e={nodeId:l,parentId:a._lastProcessedItemInCurrentGroup.parentId,type:"group",data:o,htmlNode:null};a._valueFlat.push(e),a._lastProcessedItemInCurrentGroup.position=0;for(let e=0;e<n.length&&!!n[e];e++){const t=l+"."+(a._lastProcessedItemInCurrentGroup.position||0);if(a._isMaxLevelExceeded(t))break;const i={nodeId:t,parentId:l,type:"condition",data:n[e],htmlNode:null};a._totalConditions++,a._valueFlat.push(i),a._lastProcessedItemInCurrentGroup.position++}for(let e=0;e<r.length;e++)a._lastProcessedItemInCurrentGroup.parentId=l,a._convertValueToFlat(r[e],n.length+e),a._lastProcessedItemInCurrentGroup.position++}}}_isMaxLevelExceeded(e){const t=this,a=t._valueFlat;if(!(null===t.maxLevel||1>a.length)){if(e)return e.split(".").length-2>=t.maxLevel;for(let e=0;e<a.length;e++){const i=a[e];if(i.nodeId.split(".").length-2>t.maxLevel)return!0}}}_clickHandler(e){const t=this,a=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target,i=a?a.closest(".smart-filter-group-condition"):null,l=i?i.getAttribute("node-id"):null,o=a?a.closest(".smart-filter-group"):null,n=o?o.getAttribute("node-id"):null,r=a.closest(".smart-filter-add-btn"),d=a.closest(".smart-filter-delete-btn"),s=a.closest(".filter-builder-item"),u=l||n,c=t._getItemById(u);let m;if(!t.disabled){if((s||d||r)&&(m=s?s.classList.contains("smart-filter-field-name")?"fieldButton":s.classList.contains("smart-filter-operation")?"operationButton":s.classList.contains("smart-filter-value")?"valueButton":"groupOperationButton":r?"addButton":"deleteButton",t.$.fireEvent("itemClick",{id:c.nodeId,type:c.type,component:m,data:c.data})),d){const e=a.closest(".smart-filter-group-operator"),i=a.closest(".smart-filter-group-condition");return void t._clickHandlerDeleteButton(e,i,o)}if(r)return t._closeEditor(),t._contextMenuOptions=t._addOptions,void t._handleContextMenu(a);if(s){const e=s.classList;return void t._clickHandlerFilterButton(e,u,a)}t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose"));const e=a.closest(".smart-drop-down"),i=t._editor&&t._editor.contains(a)||e&&e.ownerElement===t._editor||a.closest(".smart-custom-editor");return t._editorIsOpen&&t._editor&&!i?t._scrollBarDown?void delete t._scrollBarDown:void t._closeEditor():void 0}}_clickHandlerDeleteButton(e,t,a){const i=this;i.$.conditionsMenu.opened&&(i.$.fireEvent("menuClosing"),i.$.conditionsMenu.close(),i.$.fireEvent("menuClose")),i._closeEditor(),e?(i._deleteElement(a,"group"),i._generateValue()):t&&(i._deleteElement(t),i._generateValue()),i.$.scrollableContainer.refresh()}_clickHandlerFilterButton(e,t,a){function i(){const e=o.$.conditionsMenu.querySelector(".smart-selected-menu-item");e&&e.classList.remove("smart-selected-menu-item")}function l(e,t,a){i(),o._contextMenuOptions=0===t.length?o._defaultFilterOperationDescriptions:t,o._handleContextMenu(e);const l=o.$.conditionsMenu.querySelector("smart-menu-item[value=\""+a+"\"]");o.$.conditionsMenu.opened&&l&&l.classList.add("smart-selected-menu-item")}const o=this;if(!a.closest(".smart-editors-container")&&(o._closeEditor(),o._editedItem=o._getItemById(t),e.contains("smart-filter-field-name")||o._editedItem.data&&o._editedItem.data.length)){if(e.contains("smart-filter-group-operation"))return void l(a,o._groupOperationDescriptions,o._editedItem.data);if(e.contains("smart-filter-add-btn"))l(a,o._groupOperationDescriptions);else{if(e.contains("smart-filter-field-name"))return o._fields||o._mapFieldsToMenu(),void l(a,o._fields,o._editedItem.data[0]);if(e.contains("smart-filter-operation")){const e=o._getFieldByFieldName(o._editedItem.data[0]);if(!e)return;let t=o._filterOperationDescriptions.slice();if(e&&e.filterOperations)t=o._filterOperationDescriptions.filter(t=>-1<e.filterOperations.indexOf(t.value));else{let a;switch(e.dataType){case"number":a=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"date":a=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"datetime":a=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":a=["=","<>","isblank","isnotblank"];break;case"object":a=["isblank","isnotblank"];break;case"string":a=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:a=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"];}t=o._filterOperationDescriptions.filter(e=>-1<a.indexOf(e.value))}return o.showIcons&&(t=t.map(e=>(e.label="<div class=\"smart-filter-builder-icon\">"+o.icons[e.value]+"</div><div class=\"smart-filter-builder-menu-item\">"+o.localize(e.value)+"</div>",e))),void l(a,t.slice(),o._editedItem.data[1])}return void o._openEditor(a)}}}_closeEditor(e){const t=this;let a;if(t._editedItem&&t._editorIsOpen){if(t._editor===t.$.dateTimePickerEditor)t._editor._inputChangeHandler(),a=t._editor.value,a&&(a=a.toDate());else if(t._editor===t.$.checkBoxEditor)a=t._editor.checked;else if(t._editor===t.$.customEditor)a=t._selectedCustomCondition.handleValue(t._editor);else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),a=t._editor.value;else{const e=t._getFieldByFieldName(t._editedItem.data[0]);a="array"===e.dataType?t._editor.value.split(","):"object"===e.dataType?JSON.parse(t._editor.value):t._editor.value}const i=t._editedItem,l=i.htmlNode,o=i.nodeId,n=t._getFieldByFieldName(i.data[0]).dataType,r=l.querySelector(".smart-filter-value"),d=l.querySelector(".smart-value-container"),s={value:a,valueType:n||"string",editedItem:i};if(t.$.fireEvent("editorClosing",s),t._updateValueInFlatArray(o,a,"value",n||"string"),t._generateValue(e),r.removeAttribute("edited"),t.$.editorsContainer.removeAttribute("open"),t._editor===t.$.checkBoxEditor)d.innerHTML=t._editor.checked?"true":"false";else if(t._editor===t.$.customEditor){const e=t._selectedCustomCondition.valueTemplate(t._editor);d.innerHTML=e}else d.innerHTML=t._formatValueStringRepresentation(t._editor.value,t._editedItem.data[0]);t._editor.classList.add("smart-hidden"),t._editorIsOpen=t._enterIsPressedInEditor=!1,t.$.fireEvent("editorClose",s),t.$.scrollableContainer.refresh()}}_defaultValueByType(e){let t;switch(e){case"number":t=0;break;case"date":case"datetime":{t=new Date,t.setHours(0,0,0);break}case"boolean":t=!1;break;case"object":t=null;break;default:t="";}return t}_deleteElement(e,t){function a(e){const t=o._valueFlat.filter(t=>e===t.nodeId);let a=t?t[0]:null;o._valueFlat.splice(o._valueFlat.indexOf(a),1),o._totalConditions--}function l(e){const t=o._valueFlat.filter(t=>e===t.nodeId),i=t?t[0]:null;for(let t=0;t<o._valueFlat.length;t++){const i=o._valueFlat[t],n=i.nodeId;i.parentId===e&&("group"===i.type?l(n):a(n))}-1<o._valueFlat.indexOf(i)&&o._valueFlat.splice(o._valueFlat.indexOf(i),1)}function i(e,t){e.forEach((e,a)=>{const l=o._valueFlat.find(t=>t.htmlNode===e),n=t+"."+a;e.setAttribute("node-id",n),l.parentId=t,l.nodeId=n,e.classList.contains("smart-filter-group")&&i(Array.from(e.children[1].children),n)})}const o=this,n=e instanceof HTMLElement?e:o._valueFlat.find(t=>t.nodeId===e).htmlNode,r="string"==typeof e?e:e.getAttribute("node-id");if(r&&1!==r.length){"group"===t?l(r):a(r);for(let e=o._valueFlat.length-1;0<=e;e--){const t=o._valueFlat.filter(t=>o._valueFlat[e].parentId===t.nodeId);0===t.length&&"0"!==o._valueFlat[e].nodeId&&(o._valueFlat.splice(e,1),o._totalConditions--)}o._generateValue(),n.parentElement.removeChild(n),i(Array.from(o.$.contentContainer.firstElementChild.children[1].children),"0")}}_documentClickHandler(e){const t=this;return(t.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-filter-builder")?void t._clickHandler(e):void(t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown)}_downHandler(e){const t=this;(t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-scroll-bar")?t._scrollBarDown=!0:delete t._scrollBarDown}_containerChangeHandler(e){e.stopPropagation()}_emptyElementsStructure(e){const t=this,a=t.$.contentContainer;for(;a.firstChild;)a.removeChild(a.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_filterGroupRow(e){const t=this;e=t.localize(e||"or");let a=document.createElement("div"),i=`<span class ="smart-filter-delete-btn"></span>
                <span class ="filter-builder-item smart-filter-group-operation">${e}</span>
                <span class ="smart-filter-add-btn"></span>`;return a.className="smart-filter-group-operator",a.innerHTML=i,a.data=e||"or",a}_formatValueStringRepresentation(e,t){function a(e){return 0===e||"number"==typeof e||"string"==typeof e||!0===e||""===e||"0"===e||Array.isArray(e)||"object"==typeof e&&e.constructor===Date?new Smart.Utilities.DateTime(e):e}const i=this,l=i._getFieldByFieldName(t);let o;if(!l)return e;if((!e||0===e.length)&&"boolean"!==l.dataType&&"number"===l.dataType&&null===e||"string"===l.dataType&&(!e||0===e.length))return i.valuePlaceholder;switch(l.dataType){case"date":case"datetime":e?(e=a(e),e.calendar.days=i._localizedDays,e.calendar.months=i._localizedMonths,e.calendar.locale=i.locale,Smart.Utilities.DateTime.cache=[],o=e.toString("date"===l.dataType?i.formatStringDate:i.formatStringDateTime)):o=i.valuePlaceholder;break;case"array":o="string"==typeof e?e.split(","):e;break;case"object":o="string"==typeof e?e:JSON.stringify(e);break;case"number":o=e;break;case"boolean":o=!1===e?"false":"true";break;default:o=e+"";}return i.valueFormatFunction?i.valueFormatFunction(o,t,l.dataType||"string"):o}_generateHTMLStructureFromFlatValue(){const e=this,t=document.createDocumentFragment();if(e._valueFlat&&0!==e._valueFlat.length)for(let a=0;a<e._valueFlat.length;a++){const i=e._valueFlat[a],l=!!e.customOperations&&e.customOperations.find(e=>e.name===i.data[1]),o=i.parentId?(e.shadowRoot||e).querySelector("[node-id=\""+i.parentId+"\"]").querySelector(".smart-filter-group-condition-container"):e.$.contentContainer;if("group"===i.type){const l=document.createElement("div"),o=e._filterGroupRow(i.data),n=document.createElement("div");l.className="smart-filter-group",n.className="smart-filter-group-condition-container",l.appendChild(o),l.appendChild(n),t.appendChild(l),l.setAttribute("node-id",i.nodeId),e._valueFlat[a].htmlNode=l,e._isMaxLevelExceeded(i.nodeId+".0")&&l.setAttribute("max-level","")}else{const o=e._newFilterConditionRow(i.data);o.setAttribute("node-id",i.nodeId),t.appendChild(o),e._valueFlat[a].htmlNode=o,(-1!==["isblank","isnotblank"].indexOf(i.data[1])||l&&l.hideValue)&&o.children[3].classList.add("smart-hidden")}o.appendChild(t)}}_generateValue(){function e(e){for(let t=0;t<e.length;t++){const i=e[t];let l={};"group"===i.type&&(l.nodeId=i.nodeId,l.parentId=i.parentId,l.structure=[i.data||"or"],a.push(l))}for(let t=0;t<a.length;t++){const l=a[t],o=e.filter(e=>e.parentId===l.nodeId&&"condition"===e.type);for(let e=0;e<o.length;e++)0==e?l.structure.unshift(o[e].data):l.structure.push(o[e].data)}a=a.filter(e=>1<e.structure.length),a.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(let t=0;t<a.length;t++){const e=a[t],i=a.filter(t=>t.nodeId===e.parentId)[0];i&&i.structure&&i.structure.push(e.structure)}}const t=this;let a=[],i=t._valueFlat.slice();e(i),t.value=0<a.length?1<t._valueFlat.length?a[a.length-1].structure:a:[t._getItemById("0").data];const l=JSON.stringify(t.value);t._oldValueAsString!==l&&(t._oldValueAsString=l,t.$.fireEvent("change",{value:JSON.parse(l)}))}_getFieldByFieldName(e){const t=this,a=t.fields?t.fields.filter(t=>t.dataField===e):t._valueFields.filter(t=>t.dataField===e);return a[0]||null}_getFieldsFromValue(){const e=this,t=e._valueFlat,a=[],i=[];for(let e=0;e<t.length;e++)if("condition"===t[e].type){const l=t[e].data[0];if(-1===a.indexOf(l)){a.push(l),i.push({label:l,dataField:l,dataType:"string",format:null})}}e._valueFields=i}_getItemById(e,t){const a=this,i=a._valueFlat.filter(a=>t?a.parentId===e:a.nodeId===e),l=0<i.length?i[0]:null;return l}_handleContextMenu(e){const t=this;if(!(t._selectedElement===e&&t.$.conditionsMenu.opened)){const a=e.getBoundingClientRect(),i=t.getBoundingClientRect(),l=a.height,o=a.left+t.$.contentContainer.scrollLeft-i.left,n=a.top+t.$.contentContainer.scrollTop-i.top+l;if(e.closest(".smart-filter-add-btn")&&t.restrictedMode){t._checkFieldsExistence();const e=t.fields?t.fields[0]:t._valueFields[0],a=e.filterOperations&&0<e.filterOperations.length?e.filterOperations[0]:"=";return void t._addElement("condition",0,[e.dataField,a,t._defaultValueByType(e.dataType)])}return t._closeEditor(),t.disableContextMenu?void(t._selectedElement=e):void(t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(o,n),t._selectedElement=e,t.$.scrollableContainer.refresh())}}_handleCustomOperations(){const e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions;for(let t=0;t<e.customOperations.length;t++){const a=e.customOperations[t];e._filterOperationDescriptions.push({label:a.label,value:a.name,custom:!0,index:t,editorTemplate:a.editorTemplate,valueTemplate:a.valueTemplate,handleValue:a.handleValue})}}_initializeEditor(e){const t=this,a="smart-"+Smart.Utilities.Core.toDash(e),i=document.createElement(a);"numericTextBox"===e?(i.spinButtons=!0,i.inputFormat="floatingPoint"):"dateTimePicker"==e&&(i.calendarButton=!0,i.dropDownDisplayMode="auto",i.enableMouseWheelAction=!0,i.locale=t.locale,!i.messages[t.locale]&&(i.messages[t.locale]={}),i.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),i.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),i.tabIndex="1",i.theme=t.theme,i.animation=t.animation,t.$[e+"Editor"]=i,i.$=Smart.Utilities.Extend(i),i.className=a+"-editor smart-hidden",t.$.editorsContainer.appendChild(i),t["_"+e+"Initialized"]=!0}_innerContainerKeydownHandler(e){const t=this;("Escape"===e.key||"Enter"===e.key)&&t._editorIsOpen&&t._closeEditor()}_inputBlurHandler(){const e=this;let t;if(e._editor===e.$.dateTimePickerEditor)t=e._editor.value,t&&(t=t.toDate());else if(e._editor===e.$.checkBoxEditor)t=e._editor.checked;else if(e._editor===e.$.customEditor)t=e._selectedCustomCondition.handleValue(e._editor);else{const a=e._getFieldByFieldName(e._editedItem.data[0]);t="array"===a.dataType?e._editor.value.split(","):"object"===a.dataType?JSON.parse(e._editor.value):e._editor.value}const a=e._editedItem,i=a.nodeId,l=e._getFieldByFieldName(a.data[0]).dataType;e._updateValueInFlatArray(i,t,"value",l||"string"),e._generateValue()}_localizeInitialValues(){const e=this,t=Smart.Utilities.DateTime.getLocalizedNames(e.locale);e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("notand"),value:"notand"},{label:e.localize("or"),value:"or"},{label:e.localize("notor"),value:"notor"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}],e._localizedDays=t.days,e._localizedMonths=t.months}_mapFieldsToMenu(){const e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).map(e=>{let t={label:e.label,value:e.dataField,dataType:e.dataType};return t}))}_menuItemClickHandler(e){const t=this,a=t._selectedElement.closest(".filter-builder-item"),i=e.detail,l=i.value,o=t.localize(l)||i.label;if(a){const e=a.closest(".smart-filter-group-condition"),i=a.closest(".smart-filter-group"),n=e?e.getAttribute("node-id"):i.getAttribute("node-id");let r=2;if(a.innerHTML=o,a.value=l,t._editedItem&&a.classList.contains("smart-filter-field-name")&&t._editedItem.data[0]!==l){const e=a.parentNode.querySelector(".smart-filter-value"),i=t.customOperations.map(e=>{if(e.hideValue)return e.name}).filter(e=>e),o=i.concat(["isblank","isnotblank"]);t._clearConditionsValue(n,l),t._setInitialFilterOperation(n,l),-1<o.indexOf(l)?e.classList.add("smart-hidden"):e.classList.remove("smart-hidden")}if(a.classList.contains("smart-filter-field-name"))r=0;else if(a.classList.contains("smart-filter-operation")){const e=a.parentNode.querySelector(".smart-filter-value");let i;if(t.customOperations){const e=t.customOperations.filter(e=>e.name===l);0<e.length&&(i=e[0])}-1<["isblank","isnotblank"].indexOf(l)||i&&i.hideValue?(t._clearConditionsValue(n),e.classList.add("smart-hidden")):e.classList.remove("smart-hidden"),r=1}else if(a.classList.contains("smart-filter-group-operation")){for(let e=0;e<t._valueFlat.length;e++)t._valueFlat[e].nodeId===n&&(t._valueFlat[e].data=a.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}for(let e=0;e<t._valueFlat.length;e++)t._valueFlat[e].nodeId===n&&(t._valueFlat[e].data[r]=a.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}const n=t._selectedElement.closest(".smart-filter-group"),r=n.getAttribute("node-id");if(!t._isMaxLevelExceeded(r+".0")){if("addCondition"===l&&(t.maxConditions&&t._totalConditions<t.maxConditions||!t.maxConditions)){t._checkFieldsExistence();const e=t.fields?t.fields[0]:t._valueFields[0],a=e.filterOperations&&0<e.filterOperations.length?e.filterOperations[0]:"=";t._addElement("condition",r,[e.dataField,a,t._defaultValueByType(e.dataType)])}else"addGroup"===l&&t._addElement("group",r,"and");t.$.scrollableContainer.refresh()}}_setInitialFilterOperation(e,t){const a=this,i=a.fields.find(e=>e.dataField===t),l=a._valueFlat.find(t=>t.nodeId===e),o=l.htmlNode.getElementsByClassName("smart-filter-operation")[0],n=i&&i.filterOperations&&0<i.filterOperations.length?i.filterOperations[0]:"=";let r=a.localize(n);r||(r=a.customOperations.find(e=>e.name===n).label),l.data[1]=n,o.innerHTML=r}_checkFieldsExistence(){const e=this;e.fields&&0!==e.fields.length||e._valueFields&&0!==e._valueFields.length||e.error(e.localize("missingFields",{elementType:e.nodeName.toLowerCase()}))}_newFilterConditionRow(e){e=e||[];const t=this,a=e[0]?e[0]:t.fields[0].dataField,i=t._formatValueStringRepresentation(e[2],e[0]),l=t.fields?t.fields.filter(e=>e.dataField===a):t._valueFields.filter(e=>e.dataField===a),o=0<l.length?l[0].label:e[0];let n=t.localize(e[1]);!n&&t.customOperations&&0<t.customOperations.length&&(n=t.customOperations.find(t=>t.name===e[1]).label);let r=document.createElement("div"),d=`<span class ="smart-filter-delete-btn"></span>
                <span class ="filter-builder-item smart-filter-field-name">${o}</span>
                <span class ="filter-builder-item smart-filter-operation">${n||""}</span>
                <span class ="filter-builder-item smart-filter-value"><span class ="smart-value-container">${i}</span></span>`;return r.className="smart-filter-group-condition",r.innerHTML=d,r}_openEditor(e){const t=this,a=e&&e.closest(".smart-filter-group-condition")?e.closest(".smart-filter-group-condition").getAttribute("node-id"):null,i=e.closest(".smart-filter-value"),l=t._getItemById(a),o=l.data[0]||t.fields[0].dataField||t._valueFields[0].dataField,n=t._getFieldByFieldName(o);let r;if(l?(r=l.data[2],void 0===r&&(r="")):r="",!n)return;t._editorIsOpen&&t._closeEditor(),t.$.conditionsMenu.opened&&t.$.conditionsMenu.close(),i.setAttribute("edited",""),t._editedItem=l;const d=t.fields||t._valueFields,s=d.filter(e=>e.dataField===o),u=t._filterOperationDescriptions.filter(e=>e.value===l.data[1]&&e.custom),c=0<s.length?s[0]:null,m=n.lookup&&n.lookup.dataSource?"lookup":c.dataType;0!==u.length&&u[0].editorTemplate?(t._selectedCustomCondition=u[0],t._openCustomEditor(m,r,n)):t._openEditorByFieldType(m,r,n),t.$.fireEvent("editorOpening",{value:r,type:m,editedItem:l}),setTimeout(function(){t._editor.focus(),(t._editor===t.$.numericTextBoxEditor||t._editor===t.$.textBoxEditor)&&(t.$.scrollableContainer.scrollLeft=t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft,t.$.scrollableContainer.scrollTop=t.$.scrollableContainer.$.scrollViewerContainer.oldTop,t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft=0,t.$.scrollableContainer.$.scrollViewerContainer.scrollTop=0,t._editor.$.input.selectionStart=t._editor.$.input.selectionEnd=t._editor.$.input.value.length),t.$.scrollableContainer.refresh(),t.$.fireEvent("editorOpen",{value:r,type:m,editedItem:l})},0),t._editor.classList.remove("smart-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),i.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh()}_openEditorByFieldType(e,t,a){const i=this;"lookup"===e?(i._comboBoxInitialized||i._initializeEditor("comboBox"),i._editor=i.$.comboBoxEditor,i._editor.dataSource=a.lookup.dataSource,i._editor.dropDownAppendTo=i.$.container,i._editor.selectedValues=[t]):"boolean"===e?(i._checkBoxInitialized||i._initializeEditor("checkBox"),i._editor=i.$.checkBoxEditor,i._editor.checked=!!t):"datetime"===e?(i._dateTimePickerInitialized||i._initializeEditor("dateTimePicker"),i._editor=i.$.dateTimePickerEditor,i._editor.formatString=i.formatStringDateTime,i._editor.dropDownAppendTo=i.$.container,i._editor.value=t):"date"===e?(i._dateTimePickerInitialized||i._initializeEditor("dateTimePicker"),i._editor=i.$.dateTimePickerEditor,i._editor.formatString=i.formatStringDate,i._editor.dropDownAppendTo=i.$.container,i._editor.value=t):"number"===e?(i._numericTextBoxInitialized||i._initializeEditor("numericTextBox"),t=t?t:0,i._editor=i.$.numericTextBoxEditor,i._editor.value=t):"array"===e?(i._textBoxInitialized||i._initializeEditor("textBox"),i._editor=i.$.textBoxEditor,i._editor.value=t.toString()):"object"===e?(i._textBoxInitialized||i._initializeEditor("textBox"),t=t?t:{},i._editor=i.$.textBoxEditor,i._editor.value=JSON.stringify(t)):(i._textBoxInitialized||i._initializeEditor("textBox"),i._editor=i.$.textBoxEditor,i._editor.value=t+"")}_openCustomEditor(e,t,a){const i=this,l=i.customOperations[i._selectedCustomCondition.index].editorTemplate(e,t,a);i.$.customEditor.innerHTML="",l&&i.$.customEditor.appendChild(l),i._editor=i.$.customEditor}_refresh(){const e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e.$.scrollableContainer.refresh()}_resizeHandler(){const e=this;e.$.scrollableContainer.refresh()}_scrollViewerWheelHandler(e){const t=this;"wheel"===e.type&&t.$.scrollableContainer.scrollHeight&&(e.stopPropagation(),e.preventDefault())}_setInitialValues(){const e=this;e._mapFieldsToMenu(),e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_updatePlaceholder(){const e=this;for(let t=0;t<e._valueFlat.length;t++){const a=e._valueFlat[t];"condition"===a.type&&(null===a.data[2]||""===a.data[2])&&(a.htmlNode.querySelector(".smart-value-container").innerHTML=e.valuePlaceholder)}e.$.textBoxEditor&&(e.$.textBoxEditor.placeholder=e.valuePlaceholder)}_updateValueInFlatArray(e,t,a,i){const l=this;if(e&&!l.disabled){i=i||"string",a=a||"value",null!==t&&("number"===i?t=parseFloat(t):"boolean"===i?t=!!t:"string"===i?t+="":void 0);for(let o=0;o<l._valueFlat.length;o++)l._valueFlat[o].nodeId===e&&("column"===a?l._valueFlat[o].data[0]=t:"filterCondition"===a?l._valueFlat[o].data[1]=t:"value"===a?l._valueFlat[o].data[2]=t:"groupCondition"===a?l._valueFlat[o].data=t:void 0)}}_validateNode(e,t){const a=this;let i;return e instanceof HTMLElement?i=a._getItemById(e.getAttribute("node-id")):"string"==typeof e?i=a._getItemById(e):a.error(a.localize("wrongElementNode",{elementType:a.nodeName.toLowerCase(),method:t})),i||a.error(a.localize("wrongElementNode",{elementType:a.nodeName.toLowerCase(),method:t})),i}_validateUserData(e,t){const a=this;if(t)(!Array.isArray(e)||3>e.length)&&a.error(a.localize("invalidDataStructure",{elementType:a.nodeName.toLowerCase()}));else{const t=/^(and|or|notAnd|notOr)$/i;"string"==typeof e&&e.match(t)||a.error(a.localize("invalidDataStructure",{elementType:a.nodeName.toLowerCase()}))}}_validateValue(){function e(e){return 3===e.length&&"string"==typeof e[0]&&"string"==typeof e[1]}function t(a,r,d){let s=0;a.forEach(a=>{if(!Array.isArray(a))d.push(a);else if(e(a)){if(null!==i&&i===n||null!==l&&l===s)return;d.push(a),s++,n++}else{if(null!==o&&o===r+1)return;const e=[];d.push(e),t(a,r+1,e)}})}const a=this,i=a.maxConditions,l=a.maxConditionsPerGroup,o=a.maxLevel;let n=0;if(null!==i||null!==l||null!==o){const e=a.value,i=[];t(e,0,i),a.value=i}}}),Smart("smart-query-builder",class extends Smart.BaseElement{static get properties(){return{allowDrag:{value:!1,type:"boolean"},applyMode:{allowValues:["immediately","change"],value:"change",type:"string"},customOperations:{value:[],type:"array",reflectToAttribute:!1},dropDownWidth:{type:"any",value:"100%"},fields:{value:null,type:"array?",reflectToAttribute:!1},fieldsMode:{value:"dynamic",allowedValues:["dynamic","static"],type:"string"},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},getDynamicField:{value:null,type:"function?"},icons:{value:{"=":"equals","<>":"notequals",">":"greaterthan",">=":"greaterthanorequal","<":"lessthan","<=":"lessthanorequal",startswith:"startswith",endswith:"endswith",contains:"contains",notcontains:"notcontains",isblank:"isblank",isnotblank:"isnotblank"},type:"object",reflectToAttribute:!1},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:"{{elementType}}: Wrong parent group index in \"{{method}}\" method.",wrongElementNode:"{{elementType}}: Incorect node / node Id in \"{{method}}\" method.",invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME",queryLabel:"Query"}},type:"object",extend:!0},operatorPlaceholder:{value:"Operator",type:"string"},propertyPlaceholder:{value:"Property",type:"string"},showIcons:{value:!1,type:"boolean"},value:{value:[],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"Value",type:"string"}}}static get requires(){const e={"Smart.Button":"smart.button.js","Smart.Calendar":"smart.calendar.js","Smart.CheckBox":"smart.checkbox.js","Smart.DateTimePicker":"smart.datetimepicker.js","Smart.DropDownList":"smart.dropdownlist.js","Smart.Input":"smart.input.js","Smart.ListBox":"smart.listbox.js","Smart.Menu":"smart.menu.js","Smart.NumericTextBox":"smart.numerictextbox.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.TimePicker":"smart.timepicker.js","Smart.Tooltip":"smart.tooltip.js","Smart.Utilities.BigNumber":"smart.math.js","Smart.Utilities.DateTime":"smart.date.js","Smart.Utilities.Draw":"smart.draw.js","Smart.Utilities.NumericProcessor":"smart.numeric.js"};return window.NIComplex||(e["Smart.Utilities.Complex"]="smart.complex.js"),e}static get listeners(){return{down:"_downHandler",move:"_moveHandler",resize:"_resizeHandler","editorsContainer.keydown":"_innerContainerKeydownHandler","conditionsMenu.closing":"_menuClosingHandler","conditionsMenu.itemClick":"_menuItemClickHandler","contentContainer.change":"_contentContainerChangeHandler","document.down":"_documentDownHandler","document.move":"_documentMoveHandler","document.up":"_documentUpHandler"}}static get styleUrls(){return["smart.querybuilder.css"]}template(){return`<div id="container">
                    <smart-scroll-viewer id="scrollableContainer" class ="smart-scrollable-container" animation="[[animation]]">
                        <div id="queryLabel" class="smart-query-builder-label smart-unselectable"></div>
                        <div id="contentContainer" class ="smart-content-container"></div>
                    </smart-scroll-viewer>
                    <div id="editorsContainer" class ="smart-editors-container">
                        <div id="customEditor" class ="smart-custom-editor smart-hidden"></div>
                    </div>
                    <smart-menu id="conditionsMenu" mode="dropDown" class ="smart-conditions-menu" theme="[[theme]]" animation="[[animation]]"></smart-menu>
                </div>`}propertyChangedHandler(e,t,a){super.propertyChangedHandler(e,t,a);const i=this;switch(e){case"animation":case"theme":["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"].forEach(t=>i.$[t]&&(i.$[t][e]=a));break;case"formatStringDate":case"formatStringDateTime":case"valueFormatFunction":i._refresh();break;case"operatorPlaceholder":Array.from((i.shadowRoot||i).querySelectorAll(".smart-filter-operation[placeholder]")).forEach(e=>e.firstElementChild.innerHTML=a);break;case"propertyPlaceholder":Array.from((i.shadowRoot||i).querySelectorAll(".smart-filter-field-name[placeholder]")).forEach(e=>e.firstElementChild.innerHTML=a);break;case"showIcons":i._closeEditor(),a?i._filterOperationDescriptions.map(e=>e.icon=i.icons[e.value]):i._filterOperationDescriptions.map(e=>delete e.icon);break;case"customOperations":case"fields":case"value":{const t=JSON.stringify(i._validValue);"customOperations"===e?i._handleCustomOperations():""==e&&i._mapFieldsToMenu(),i._applyValue(),i._oldValueAsString!==t&&(i._oldValueAsString=t,i.$.fireEvent("change",{value:JSON.parse(t)}));break}case"valuePlaceholder":Array.from((i.shadowRoot||i).querySelectorAll(".smart-filter-value[placeholder]")).forEach(e=>e.firstElementChild.innerHTML=a);break;case"locale":case"messages":i._localizeInitialValues(),i._refresh(),i._handleCustomOperations(),i.$.dateTimePickerEditor&&(!i.$.dateTimePickerEditor.messages[i.locale]&&(i.$.dateTimePickerEditor.messages[i.locale]={}),i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel=i.localize("dateTabLabel"),i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel=i.localize("timeTabLabel"),"locale"===e?i.$.dateTimePickerEditor.locale=i.locale:"messages"==e&&(i.$.dateTimePickerEditor.$.selectDate.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel,i.$.dateTimePickerEditor.$.selectTime.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel));break;case"icons":i._closeEditor();}}ready(){super.ready();const e=this;-1!==navigator.platform.toLowerCase().lastIndexOf("mac")&&e.$.contentContainer.classList.add("mac"),e._setInitialValues(),e._handleCustomOperations(),e._applyValue(),Object.defineProperty(e,"value",{get:function(){return e.context===e?e.properties.value.value:e._validValue},set(t){e.updateProperty(e,e._properties.value,t)}})}_setInitialValues(){const e=this;e._autoScrollCoefficient=Smart.Utilities.Core.Browser.Firefox?4:Smart.Utilities.Core.Browser.Edge?8:2,e._isMobile=Smart.Utilities.Core.isMobile,e._manuallyAddedFields=[],e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_applyValue(){const e=this;e._emptyElementsStructure(!0),e._validateValue(),e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._mapFieldsToMenu(),e._generateHTMLStructureFromFlatValue(!0),e._restrictNesting(),e._validValue=e._getValidValue(),e._oldValueAsString=JSON.stringify(e._validValue)}_setRequiredFields(){const e=this;if(e.requiredFields&&e.requiredFields.length){const t=e.value;let a=[];for(let l=0;l<e.requiredFields.length;l++){const i=e.requiredFields[l],o=e.fields.find(e=>e.dataField===i);if(o){let e=[];if(t)for(let a=0;a<t.length;){const i=t[a];if(Array.isArray(i))for(let t,a=0;a<i.length;){if(t=i[a],t&&t[0]===o.dataField){e.push(t),i.splice(0<a?a-1:a,2);continue}a++}if(!i.length){t.splice(a,2);continue}a++}for(let t=0;t<e.length;t++)a.push(e[t]),a.push("and")}}"string"==typeof a[a.length-1]&&a.pop(),e.value.unshift(a,"and")}}_contentContainerChangeHandler(e){const t=this;if(e.stopPropagation(),"immediately"===t.applyMode&&t._editorIsOpen&&t._editor){const e=t._editor.closest(".filter-builder-item");e.classList.contains("smart-filter-value")||t._closeEditor()}}_mapFieldsToMenu(){const e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).concat(e._manuallyAddedFields).map(e=>({label:e.label,value:e.dataField,dataType:e.dataType,filterOperations:e.filterOperations,lookup:e.lookup})))}_localizeInitialValues(){const e=this;e.$.queryLabel.innerHTML=e.localize("queryLabel"),e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("or"),value:"or"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}];const t=Smart.Utilities.DateTime.getLocalizedNames(e.locale);e._localizedDays=t.days,e._localizedMonths=t.months}_handleCustomOperations(){const e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions.slice(0);for(let t=0;t<e.customOperations.length;t++){const a=e.customOperations[t];e._filterOperationDescriptions.push({label:a.label,value:a.name,custom:!0,index:t,editorTemplate:a.editorTemplate,valueTemplate:a.valueTemplate,handleValue:a.handleValue,hideValue:a.hideValue})}}_innerContainerKeydownHandler(e){const t=this;t._editorIsOpen&&("Escape"===e.key||"Enter"===e.key)&&t._closeEditor()}_documentDownHandler(e){const t=this,a=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(!(a.shadowParent&&a.shadowParent.closest(".smart-input-drop-down-menu")||a.closest(".smart-input-drop-down-menu")||t.$.conditionsMenu.contains(a))){const i=a.closest(".smart-drop-down");return a.getRootNode().host===t||a.closest("smart-query-builder")===t||i&&t.contains(i.ownerElement)?void t._clickHandler(e.originalEvent):void(t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown)}}_emptyElementsStructure(e){const t=this,a=t.$.contentContainer;for(;a.firstChild;)a.removeChild(a.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_resizeHandler(){this.$.scrollableContainer.refresh()}_getTotalConditions(){return this.getElementsByClassName("smart-filter-group-condition").length}_validateValue(){const e=this,t=e.value;if(!Array.isArray(t)||""===JSON.stringify(t).replace(/[\[\]]/g,""))return void(e.value=[[[]]]);for(3===t.length&&"string"==typeof t[0]&&(e.value=[[t]]),Array.isArray(t[0])&&3===t[0].length&&"string"==typeof t[0][0]&&(e.value=[t]);"string"==typeof t[0];)t.shift();for(;"string"==typeof t[t.length-1];)t.pop();e.value.forEach(e=>{Array.isArray(e)&&0===e.length&&e.push([])})}_convertValueToFlat(e){function t(e,r){let d;for(let s=0;s<e.length;s++){const i=e[s],u="string"==typeof i&&-1<l.indexOf(i);let c={htmlNode:null};if(u){d=i.trim();continue}if(d=d||"and",Array.isArray(i)){let e=a._valueFlat.filter(e=>e.parentId+""==r+"").length;if(!i.find(e=>Array.isArray(e))){if(a.maxConditions&&o>=a.maxConditions||a.maxConditionsPerGroup&&e>=a.maxConditionsPerGroup)continue;0!=s&&(a._valueFlat.push({nodeId:r+"."+e,type:"operator",data:d,parentId:r+""}),d="",e++),c.nodeId=r+"."+e,c.parentId=r+"",c.type="condition",c.data=i,o++,a._valueFlat.push(c)}else c.nodeId=(n+=1)+"",c.type="group",c.data=d,a._valueFlat.push(c),t(i,c.nodeId),d=""}}}const a=this,l=["and","or","notAnd","notOr"];if(!e)return;let o=0,n=0;a._valueFlat=[],t(e,0),delete a._totalGroups}_getFieldsFromValue(){function e(e){return"boolean"==typeof e?"boolean":e instanceof Date?0<e.getHours()||0<e.getMinutes()||0<e.getSeconds()?"datetime":"date":isNaN(e)?"string":"number"}const t=this,a=t._valueFlat,i=[],l=[];for(let t=0;t<a.length;t++){const o=a[t];if("condition"===o.type){const t=o.data[0];if(t&&-1===i.indexOf(t)){const a={label:t,dataField:t,dataType:e(o.data[2]),format:null};i.push(t),l.push(a)}}}t._valueFields=l}_addElement(e,t,a,i){const l=this,o=l._valueFlat.filter(e=>e.parentId===t);let n=0,r="";if(a=a||("group"===e?"or":[]),o.length){let e=o.map(e=>{const t=e.nodeId.split(".");return parseInt(t[t.length-1])});e=0===e.length?[0]:e,n=e.reduce((e,t)=>Math.max(e,t))+1}t&&0<t.length&&(r=".");let d=(t||"")+r+("group"===e?l._valueFlat.filter(e=>"group"===e.type).length+1:n),u=o[0];if(o.length)for(let e=0;e<o.length;e++){const t=o[e],a=t.nodeId.split(".").pop();parseInt(a)>parseInt(u.nodeId.split(".").pop())&&(u=t)}else u=l._valueFlat.find(e=>e.nodeId===t);let s=u?l._valueFlat.indexOf(u)+1:l._valueFlat.length;"condition"===e&&0<o.length&&(l._valueFlat.splice(s,0,{nodeId:d,parentId:t,type:"operator",data:["and"],htmlNode:null}),d=(t||"")+r+(n+1),s++);const c={nodeId:d,parentId:t,type:e,data:a,htmlNode:null};l._valueFlat.splice(s,0,c),"group"===e&&l._addElement("condition",d,[],!0),i||l._refresh()}_deleteElement(e,t){function a(e){const t=n._valueFlat[e];if(t&&"operator"===t.type)return n._valueFlat.splice(e,1),t.htmlNode.parentElement.removeChild(t.htmlNode),!0}function l(e){let t,i=0,l=e.split(".");l.pop(),l=l.join(".");for(let a=0;a<n._valueFlat.length;a++){const o=n._valueFlat[a];if("condition"===o.type){if(o.nodeId===e){t=o;break}o.parentId===l&&i++}}const o=n._valueFlat.indexOf(t);n._valueFlat.splice(o,1),t.htmlNode.parentElement.removeChild(t.htmlNode);const r=a(o-1);i||a(o-(r?1:0));const d=n._valueFlat.filter(e=>e.nodeId===l)[0].htmlNode;0<d.children[1].childElementCount&&d.children[2].hasAttribute("limit-selection")&&!d.children[1].lastElementChild.hasAttribute("limit-selection")&&d.children[2].removeAttribute("limit-selection")}function o(e){const t=n._valueFlat.filter(t=>e===t.nodeId&&"group"===t.type)[0];for(let t=0;t<n._valueFlat.length;t++){const a=n._valueFlat[t],i=a.nodeId;a.parentId===e&&("group"===a.type?o(i):l(i))}-1<n._valueFlat.indexOf(t)&&n._valueFlat.splice(n._valueFlat.indexOf(t),1),t.htmlNode.parentElement.removeChild(t.htmlNode)}const n=this,i="string"==typeof e?e:e.getAttribute("node-id");if(i&&1!==i.length&&("group"===t?o(i):l(i),!t||"condition"===t)){let e=i.split(".");if(e.pop(),e=e.join("."),!n._valueFlat.filter(t=>t.parentId===e).length&&(1<n._valueFlat.filter(e=>"group"===e.type).length&&o(e),"0"===e)){const e=n._valueFlat.find(e=>"group"===e.type),t=e.nodeId;e.nodeId="0",e.htmlNode.setAttribute("node-id","0");const a=n._valueFlat.filter(e=>e.parentId===t);for(let e=0;e<a.length;e++){const t=a[e];t.parentId="0",t.nodeId="0."+e,t.htmlNode.setAttribute("node-id",t.nodeId)}}n._generateValue()}}_generateHTMLStructureFromFlatValue(e){const t=this,a=document.createDocumentFragment();if(t._valueFlat&&0!==t._valueFlat.length){for(let e=0;e<t._valueFlat.length;e++){const i=t._valueFlat[e],l=!!t.customOperations&&t.customOperations.find(e=>e.name===i.data[1]),o=i.parentId?(t.shadowRoot||t).querySelector("[node-id=\""+i.parentId+"\"]").querySelector(".smart-filter-group-condition-container"):t.$.contentContainer;if("group"===i.type){const l=document.createElement("div"),o=t.localize(i.data)||"";l.className="smart-filter-group",l.innerHTML="<div class=\"smart-filter-group-operator\">"+o+"</div><div class=\"smart-filter-group-condition-container\"></div><div class=\"smart-filter-add-condition-btn\"><div>"+t.localize("add")+"</div></div><div class=\"smart-filter-add-btn\"></div>",l.firstElementChild.data=o,a.appendChild(l),l.setAttribute("node-id",i.nodeId),t._valueFlat[e].htmlNode=l}else if("condition"===i.type){const o=t._newFilterConditionRow(i.data);if(o.setAttribute("node-id",i.nodeId),a.appendChild(o),t._valueFlat[e].htmlNode=o,void 0!==i.data[0]&&void 0===i.data[1]){const e=t._getFilterOperations(t._fields.find(e=>e.value===i.data[0]));t._handleOnlyOperation(e,i.data,o)}else(-1!==["isblank","isnotblank"].indexOf(i.data[1])||l&&l.hideValue)&&(i.data.splice(2,1),o.children[2].classList.add("smart-visibility-hidden"))}else{const l=document.createElement("div");l.className="smart-filter-nested-operator",l.setAttribute("node-id",i.nodeId),l.innerHTML=t.localize(i.data),a.appendChild(l),t._valueFlat[e].htmlNode=l}o.appendChild(a)}e&&t._validateValueAdvanced(),t.$.scrollableContainer.refresh()}}_validateValueAdvanced(){const e=this,t=e.value;let a=!1,i=!1,l=0;for(let e=0;e<t.length;e++){const o=t[e];if("string"!=typeof o)for(let e,t=o.length-1;0<=t;t--){if(e=o[t],Array.isArray(e)&&0===e.length&&t!=o.length-1)o.splice(t,1),0==t&&o.splice(0,1),a=!0;else if("string"==typeof e){e=e.toLowerCase(),l++,(1<l||"and"!==e&&"or"!==e)&&(i=!0);continue}l=0}}a&&(e._emptyElementsStructure(!0),e._convertValueToFlat(e.value),e._generateHTMLStructureFromFlatValue()),i&&e._generateValue(!0)}_restrictNesting(){const e=this,t=Array.from(e.getElementsByClassName("smart-filter-add-condition-btn"));t.forEach(e=>{const t=e.previousElementSibling.lastElementChild;t&&t.hasAttribute("limit-selection")&&e.setAttribute("limit-selection","")})}_clickHandler(e){const t=this,a=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target;if(!t.disabled&&a&&a.closest&&(t._isMobile||0===e.button)){if(t._scrollBarDown)return void delete t._scrollBarDown;const e=a.closest(".smart-drop-down"),i=t._editor&&t._editor.contains(a)||e&&(t._editor.contains(e.ownerElement)||t._editor===e.ownerElement)||a.closest(".smart-custom-editor");t._editor&&t._editorIsOpen&&!i&&t._closeEditor();const l=a.closest(".smart-filter-group-condition")||a.closest(".smart-filter-nested-operator")||a.closest(".smart-filter-group");if(l){const e=t._getItemById(l.getAttribute("node-id"));if(e){if(t.$.fireEvent("itemClick",{id:e.nodeId,type:e.type,data:e.data}),a.closest(".smart-filter-delete-btn"))return void t._clickHandlerDeleteButton(e.htmlNode);const i=a.closest(".smart-filter-add-btn")||a.closest(".smart-filter-add-condition-btn");if(i){const l=i.closest(".smart-filter-group").getAttribute("node-id");return void(i.classList.contains("smart-filter-add-condition-btn")&&(t.maxConditions&&t._getTotalConditions()<t.maxConditions||!t.maxConditions)?t._addElement("condition",l,[]):t._clickHandlerFilterButton(i.classList,e.nodeId,a))}const l=a.closest(".filter-builder-item")||a.closest(".smart-filter-group-operator")||a.closest(".smart-filter-nested-operator");if(l){const i=l.classList;t._clickHandlerFilterButton(i,e.nodeId,a)}}}}}_downHandler(e){const t=this;if(e.originalEvent&&(t._isMobile||0===e.button)){const a=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(t.allowDrag&&a.classList.contains("smart-filter-group-condition")&&e.pageX<a.getBoundingClientRect().left){const i=t._valueFlat.filter(e=>"condition"===e.type);return 1===i.length||2===i.length&&i[0].parentId===i[1].parentId&&i[1].htmlNode.hasAttribute("limit-selection")?void 0:(t._dragDetails={coords:{x:e.pageX,y:e.pageY},item:a,originalEvent:e},t.$.scrollableContainer._scrollView.disableSwipeScroll=!0,t._hoveredCondition=a,void window.getSelection().removeAllRanges())}this._scrollBarDown=a.closest("smart-scroll-bar"),e.stopPropagation(),e.preventDefault()}}_moveHandler(e){"touchmove"===e.originalEvent.type&&e.originalEvent.preventDefault()}_documentMoveHandler(e){var t=Math.abs;const a=this,i=a._dragDetails;if(!i)return;const l=i.item;if(!i.feedbackShown)if(5<t(i.coords.x-e.pageX)||5<t(i.coords.y-e.pageY)){const t=a._valueFlat.filter(e=>e.htmlNode===l)[0],o=a.$.fireEvent("dragStart",{data:t.data,item:l,originalEvent:e});if(o.defaultPrevented)return delete a._dragDetails,delete a._hoveredCondition,void(a.$.scrollableContainer._scrollView.disableSwipeScroll=!1);i.allConditions=Array.from((a.shadowRoot||a).querySelectorAll(".smart-filter-group-condition")),i.data=t,i.feedback=a._addDragFeedback(),i.feedbackShown=!0,l.classList.add("dragged")}else return;const o=e.clientY;let n,r=a.shadowRoot||a.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(a.$.fireEvent("dragging",{data:i.data,item:l,originalEvent:e}),a.setAttribute("dragging",""),i.feedback.style.left=e.pageX+10+"px",i.feedback.style.top=e.pageY+10+"px",a._isMobile){const t=a._hoveredCondition;t&&(t.classList.remove("drop-target","top","bottom"),delete a._hoveredCondition);const i=document.elementFromPoint(e.clientX,o);i&&(r=i)}let d,s=r.closest(".smart-filter-group-condition");if(s){n=s;const e=n.getBoundingClientRect(),a=t(o-e.top),i=t(o-e.bottom);d=a<i?"top":"bottom"}else{let e,a;i.allConditions.forEach(i=>{const l=i.getBoundingClientRect(),n=t(o-l.top),r=t(o-l.bottom),s=Math.min(n,r);(void 0===a||s<a)&&(e=i,a=s,d=n<r?"top":"bottom")}),s=e}if(s!==l&&!(s.hasAttribute("limit-selection")&&"bottom"===d)){const e=Array.from(s.parentElement.getElementsByClassName("smart-filter-group-condition")),t=e.indexOf(l);-1!==t&&("top"===d&&s===e[t+1]||"bottom"===d&&s===e[t-1])&&(s=void 0)}else s=void 0;if(n=s,i.side=d,clearInterval(a._dragInterval),a._dragInterval=setInterval(function(){const t=a.getBoundingClientRect();0<a.$.scrollableContainer.scrollHeight&&t.left<=e.clientX&&t.left+t.width>=e.clientX?o>=t.top&&o<=t.top+36?a.$.scrollableContainer.scrollTop-=a._autoScrollCoefficient:o>=t.top+t.height-36&&o<=t.top+t.height?a.$.scrollableContainer.scrollTop+=a._autoScrollCoefficient:clearInterval(a._dragInterval):clearInterval(a._dragInterval)},1),n){a._hoveredCondition&&n!==a._hoveredCondition&&a._hoveredCondition.classList.remove("drop-target","top","bottom");const e=n.closest(".smart-filter-group");if(e&&e.hasAttribute("restricted"))return void(a._hoveredCondition=void 0);a._hoveredCondition=n,n.classList.remove("top","bottom"),n.classList.add(d,"drop-target")}else a._hoveredCondition&&(a._hoveredCondition.classList.remove("drop-target","top","bottom"),delete a._hoveredCondition)}_addDragFeedback(){const e=document.createElement("div");return e.className="smart-query-builder-drag-feedback",document.body.appendChild(e),e}_documentUpHandler(e){const t=this,a=t._dragDetails;if(!a)return void(t.$.conditionsMenu.opened&&t._selectedElement&&!t._selectedElement.classList.contains("smart-filter-add-btn")&&t.$.conditionsMenu._hoverViaKeyboard(t.$.conditionsMenu.querySelector("smart-menu-item[value=\""+t._editedItem.data+"\"]")));const i=a.item,l=a.data,o=t._hoveredCondition;if(delete t._dragDetails,delete t._hoveredCondition,t.$.scrollableContainer._scrollView.disableSwipeScroll=!1,!t.hasAttribute("dragging"))return;if(clearInterval(t._dragInterval),window.getSelection().removeAllRanges(),t.removeAttribute("dragging"),i.classList.remove("dragged"),document.body.removeChild(a.feedback),!o)return void t.$.fireEvent("dragEnd",{data:l.data,item:i,originalEvent:e,target:null,targetData:null,targetSide:null});const n=t._valueFlat.filter(e=>e.htmlNode===o)[0],r=t.$.fireEvent("dragEnd",{data:l.data,item:i,originalEvent:e,target:o,targetData:n.data,targetSide:a.side});if(o.classList.remove("drop-target","top","bottom"),r.defaultPrevented)return;const d=t.value,s=l.nodeId.split(".").map(e=>parseFloat(e)),u=d[2*(s[0]-1)],c=n.nodeId.split(".").map(e=>parseFloat(e)),m=d[2*(c[0]-1)];let p="and";1<u.length&&(0===s[1]?(p=u[1],u[1]="!remove!"):(p=u[s[1]-1],u[s[1]-1]="!remove!")),u[s[1]]="!remove!","top"===a.side?m.splice(c[1],0,l.data,p):m.splice(c[1]+1,0,p,l.data);for(let t=0;t<d.length;t++)Array.isArray(d[t])&&(d[t]=d[t].filter(e=>"!remove!"!==e));for(let t=d.length-1;0<=t;t--)Array.isArray(d[t])&&0===d[t].length&&(0==t?d.splice(0,2):(d.splice(t-1,2),t--));t._emptyElementsStructure(!0),t._convertValueToFlat(d),t._generateHTMLStructureFromFlatValue(),t._validValue=t._getValidValue();const _=JSON.stringify(t._validValue);t._oldValueAsString!==_&&(t._oldValueAsString=_,t.$.fireEvent("change",{value:JSON.parse(_)}))}_clickHandlerDeleteButton(e,t){const a=this;if(e&&e.classList){if(a._closeEditor(),1===a.getElementsByClassName("smart-filter-group-condition").length){const e=a._valueFlat[1].htmlNode.children;a.value=[[[]]],a._validValue=a._getValidValue(),a._valueFlat[1].data=[],a._valueFlat[1].htmlNode.setAttribute("limit-selection",""),e[0].setAttribute("placeholder",""),e[1].setAttribute("placeholder",""),e[2].setAttribute("placeholder",""),e[0].firstElementChild.innerHTML=a.propertyPlaceholder,e[1].firstElementChild.innerHTML=a.operatorPlaceholder,e[2].firstElementChild.innerHTML=a.valuePlaceholder;const t=JSON.stringify(a._validValue);return void(a._oldValueAsString!==t&&(a._oldValueAsString=t,a.$.fireEvent("change",{value:JSON.parse(t)})))}if(e.classList.contains("smart-filter-group")){if(t&&0<a._valueFlat.filter(t=>t.parentId===e.getAttribute("node-id")).length)return;a._deleteElement(e,"group")}else a._deleteElement(e);a._generateValue(),a.$.scrollableContainer.refresh(),Array.from(a.$.contentContainer.children).forEach((e,t)=>{const i=(t+1).toString();e.setAttribute("node-id",i),a._valueFlat.filter(t=>t.htmlNode===e)[0].nodeId=i,Array.from(e.children[1].children).forEach((e,t)=>{const l=a._valueFlat.filter(t=>t.htmlNode===e)[0],o=i+"."+t;e.setAttribute("node-id",o),l.parentId=i,l.nodeId=o})})}}_menuClosingHandler(e){const t=e.detail;"interaction"===t.trigger&&this._selectedElement===t.target&&e.preventDefault()}_menuItemClickHandler(e){const t=this,a=t._selectedElement.closest(".smart-filter-group-operator, .smart-filter-nested-operator"),i=e.detail,l=i.value;let o;if(a){a.innerHTML=t.localize(l)||i.label,a.value=l,o=a.classList.contains("smart-filter-nested-operator")?a.getAttribute("node-id"):a.parentElement.getAttribute("node-id");for(let e=0;e<t._valueFlat.length;e++)if(t._valueFlat[e].nodeId===o){t._valueFlat[e].data=a.value;break}t._generateValue()}else o=t._selectedElement.parentElement.getAttribute("node-id"),t._addElement("group",null,l);t.$.scrollableContainer.refresh()}_newFilterConditionRow(e=[]){const t=this,a=e[0];let i,l=t._fields.find(e=>e.value===a),o=l?l.label:void 0;if(void 0===a||!o&&"static"===t.fieldsMode)e.length=0;else{o||(l=t._getDynamicFieldInfo(a),o=l.label,e[0]=l.dataField);const n=t._getFilterOperations(l);i=n.find(t=>t.value===e[1]),i?i=i.label:e.splice(1,2)}const n=t._formatValueStringRepresentation(e[2],e[0],e[1]);let r=document.createElement("div"),d="<div class =\"filter-builder-item smart-filter-field-name\" "+(o?"><div class =\"smart-value-container\">"+o:"placeholder><div class =\"smart-value-container\">"+t.propertyPlaceholder)+"</div></div><div class =\"filter-builder-item smart-filter-operation\" "+(i?"><div class =\"smart-value-container\">"+i:"placeholder><div class =\"smart-value-container\">"+t.operatorPlaceholder)+"</div></div><div class =\"filter-builder-item smart-filter-value\" "+(void 0===e[2]?"placeholder><div class =\"smart-value-container\">"+t.valuePlaceholder:"><div class =\"smart-value-container\">"+n)+"</div></div><div class =\"smart-filter-delete-btn\"></div>";return r.className="smart-filter-group-condition",r.innerHTML=d,e.length||r.setAttribute("limit-selection",""),r}_formatValueStringRepresentation(e,t,a){const i=this,l=i._getFieldByFieldName(t);let o;if(!l)return e;if(void 0===e||null===e)return i.valuePlaceholder;if(void 0!==a&&i.customOperations&&0<i.customOperations.length&&(a=i.customOperations.find(e=>e.name===a),a&&a.valueTemplate))return a.valueTemplate(i._editor,e);switch(l.dataType){case"date":case"datetime":e=e instanceof Date||"string"==typeof e||"number"==typeof e&&!isNaN(e)?new Smart.Utilities.DateTime(e):e,e.calendar.days=i._localizedDays,e.calendar.months=i._localizedMonths,e.calendar.locale=i.locale,o=e.toString("date"===l.dataType?i.formatStringDate:i.formatStringDateTime);break;case"array":o="string"==typeof e?e.split(","):e;break;case"object":o="string"==typeof e?e:JSON.stringify(e);break;case"number":o=e;break;case"boolean":o=!!e;break;default:o=e+"";}return i.valueFormatFunction?i.valueFormatFunction(o,t,l.dataType||"string"):o}_getFieldByFieldName(e){return Object.assign({},this._fields.find(t=>t.value===e))}_refresh(){const e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e._restrictNesting()}_generateValue(e){const t=this;let a=[],l=t._valueFlat.slice(0),o=[];for(let t=0;t<l.length;t++){const e=l[t];let i={};"group"===e.type&&(i.nodeId=e.nodeId,i.parentId=e.parentId,i.data=e.data,i.structure=[],a.push(i))}for(let t=0;t<a.length;t++){const e=a[t];for(let t=0;t<l.length;t++){const a=l[t];if(a.parentId===e.nodeId&&"condition"===a.type){const i=l[t-1];i&&i.parentId===e.nodeId&&"operator"===i.type&&e.structure.push(i.data.toString()),e.structure.push(a.data)}}}a=a.filter(e=>0<e.structure.length),a.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(let t=0;t<a.length;t++){const e=a[t],i=a.filter(t=>t.nodeId===e.parentId)[0];if(i&&i.structure){i.structure.push(e.structure);continue}if("0"===e.nodeId){o=o.concat(e.structure);continue}e.data&&(0<t&&o.push(e.data),o.push(e.structure))}if(t.value=o,t._validateValue(),t._validValue=t._getValidValue(),!e){const e=JSON.stringify(t._validValue);t._oldValueAsString!==e&&(t._oldValueAsString=e,t.$.fireEvent("change",{value:JSON.parse(e)}))}}_getItemById(e,t){const a=this,i=a._valueFlat.filter(a=>t?a.parentId===e:a.nodeId===e),l=0<i.length?i[0]:null;return l}_closeEditor(e){const t=this;let a;if(t._editedItem&&t._editorIsOpen){const i=t._editedItem,l=t._editor.closest(".filter-builder-item"),o=l.querySelector(".smart-value-container"),n=l.parentElement,r=n.children[2];if(t._editor===t.$.dateTimePickerEditor)t._editor._inputChangeHandler(),a=t._editor.value,a&&(a=a.toDate());else if(t._editor===t.$.checkBoxEditor)a=t._editor.checked;else if(t._editor===t.$.customEditor){if(t._editor){const e=Array.from(t._editor.getElementsByTagName("smart-numeric-text-box"));e.forEach(e=>e._inputBlurHandler())}a=t._selectedCustomCondition.handleValue(t._editor)}else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),a=t._editor.value;else if(l.classList.contains("smart-filter-value")){const e=t._getFieldByFieldName(t._editedItem.data[0]);a="array"===e.dataType?t._editor.value.split(","):"object"===e.dataType?JSON.parse(t._editor.value):t._editor.value}else a=t._editor.value;if(l.classList.contains("smart-filter-field-name")){if(""===a.trim())return void t._hideEditor(l,void 0===i.data[0]);n.hasAttribute("limit-selection")&&(n.removeAttribute("limit-selection"),n.parentElement.nextElementSibling.removeAttribute("limit-selection"));const e=t._fields.find(e=>e.label===a),d=i.data[0];if(e)i.data[0]=e.value;else if("dynamic"===t.fieldsMode){const e=t._getDynamicFieldInfo(a);a=e.label,i.data[0]=e.dataField}else return o.innerHTML=t._fields.find(e=>e.value===d).label,void t._hideEditor(l);o.innerHTML=a,t._handleFieldChange([d,i.data[0]],[r,i,n])}else l.classList.contains("smart-filter-operation")?t._handleOperationChange([i,a,t._editor.$.input.dataValue],[o,r]):(i.data[2]=a,o.innerHTML=t._formatValueStringRepresentation(a,t._editedItem.data[0],t._editedItem.data[1]));t._generateValue(e),t._hideEditor(l)}}_getDynamicFieldInfo(e){const t=this,a={label:e,dataField:e,dataType:"string"};if(t.getDynamicField){const i=t.getDynamicField(e);i.label&&(a.label=i.label),i.dataField&&(a.dataField=i.dataField),i.dataType&&(a.dataType=i.dataType),i.filterOperations&&Array.isArray(i.filterOperations)&&0<i.filterOperations.length&&(a.filterOperations=i.filterOperations),i.lookup&&(a.lookup=i.lookup)}return t._manuallyAddedFields.push(a),t._mapFieldsToMenu(),a}_handleFieldChange(e,t){const a=this,i=e[0],l=t[1],o=t[2],n=t[0],r=a._fields.find(t=>t.value===e[1]),d=a._getFilterOperations(r);if(!i||void 0===l.data[1])return void a._handleOnlyOperation(d,l.data,o);const s=a._fields.find(e=>e.value===i),u=s.dataType,c=r.dataType;if(r!==s&&(c!==u||r.filterOperations||s.filterOperations)){const e=!!d.find(e=>e.value===l.data[1]);return e?c===u?void 0:"date"===c&&"datetime"===u||"datetime"===c&&"date"===u?void(n.firstElementChild.innerHTML=a._formatValueStringRepresentation(l.data[2],l.data[0],l.data[1])):(l.data.splice(2,1),n.setAttribute("placeholder",""),void(n.firstElementChild.innerHTML=a.valuePlaceholder)):void(l.data.splice(1,2),o.children[1].setAttribute("placeholder",""),o.children[1].firstElementChild.innerHTML=a.operatorPlaceholder,n.setAttribute("placeholder",""),n.firstElementChild.innerHTML=a.valuePlaceholder,n.classList.remove("smart-visibility-hidden"),a._handleOnlyOperation(d,l.data,o))}}_handleOnlyOperation(e,t,a){if(1===e.length){const i=e[0];t[1]=i.value,a.children[1].removeAttribute("placeholder",""),a.children[1].firstElementChild.innerHTML=e[0].label,("isblank"===i.value||"isnotblank"===i.value||i.custom&&i.hideValue)&&(t.splice(2,1),a.children[2].classList.add("smart-visibility-hidden"))}}_handleOperationChange(e,t){const a=this,i=e[0],l=e[1],o=e[2],n=t[0],r=t[1],d=i.data[1]===void 0?void 0:a._filterOperationDescriptions.find(e=>e.value===i.data[1]),s=a._filterOperationDescriptions.find(e=>e.value===o),u=s.value;s===d||(i.data[1]=u,n.innerHTML=l,"isblank"===u||"isnotblank"===u||s.custom&&s.hideValue?(i.data.splice(2,1),r.classList.add("smart-visibility-hidden")):r.classList.contains("smart-visibility-hidden")?(r.setAttribute("placeholder",""),r.classList.remove("smart-visibility-hidden"),r.firstElementChild.innerHTML=a.valuePlaceholder):(s.custom||d&&d.custom)&&(i.data.splice(2,1),r.setAttribute("placeholder",""),r.firstElementChild.innerHTML=a.valuePlaceholder))}_hideEditor(e,t){const a=this;t&&e.setAttribute("placeholder",""),e.removeAttribute("edited"),a.$.editorsContainer.removeAttribute("open"),a._editor.close&&a._editor.close(),a._editor.classList.add("smart-hidden"),a._editorIsOpen=a._enterIsPressedInEditor=!1,a.$.scrollableContainer.refresh()}_clickHandlerFilterButton(e,t,a){function i(e,t,a){l._contextMenuOptions=0===t.length?l._defaultFilterOperationDescriptions:t,l._handleContextMenu(e),l.$.conditionsMenu.opened&&(l.$.conditionsMenu._discardKeyboardHover(),l.$.conditionsMenu._hoverViaKeyboard(l.$.conditionsMenu.querySelector("smart-menu-item[value=\""+a+"\"]")))}const l=this;if(!a.closest(".smart-editors-container")){if(l._closeEditor(),l._editedItem=l._getItemById(t),e.contains("smart-filter-add-btn"))return void i(a,l._groupOperationDescriptions);if(e.contains("smart-filter-field-name")||l._editedItem.data&&l._editedItem.data.length)if(e.contains("smart-filter-group-operator")||e.contains("smart-filter-nested-operator"))i(a,l._groupOperationDescriptions,l._editedItem.data);else{const e=a.closest(".filter-builder-item");e.removeAttribute("placeholder"),l._openEditor(a)}}}_handleContextMenu(e){const t=this;if(t._selectedElement===e&&t.$.conditionsMenu.opened)return void t.$.conditionsMenu.close();if(t._closeEditor(),t.disableContextMenu)return void(t._selectedElement=e);const a=e.getBoundingClientRect(),i=t.getBoundingClientRect(),l=a.left+t.$.contentContainer.scrollLeft-i.left,o=a.top+t.$.contentContainer.scrollTop-i.top+a.height;t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(l,o+3),t._selectedElement=e,t.$.scrollableContainer.refresh()}_openEditor(e){const t=this,a=e&&e.closest(".smart-filter-group-condition")?e.closest(".smart-filter-group-condition").getAttribute("node-id"):null,i=e.closest(".filter-builder-item"),l=t._getItemById(a);let o="";l.data[0]===void 0?t._fields.length&&(o=t._fields[0].value):o=l.data[0];let n,r,d=t._getFieldByFieldName(o),s="";if(i.classList.contains("smart-filter-field-name"))r=0,t._fields||t._mapFieldsToMenu(),d.lookup={dataSource:t._fields.slice(),readonly:!1},s=d.label||"",n=d.value;else if(i.classList.contains("smart-filter-operation")){r=1;let e=t._getFilterOperations(d);d.lookup={dataSource:e,readonly:!0};let a=e.find(e=>e.value===l.data[r])||e[0];s=a.label,n=a.value}else r=2,s=l.data[r],void 0===s&&(s="");t._editorIsOpen&&t._closeEditor(),i.setAttribute("edited",""),t._editedItem=l;const u=t._fields,c=u.filter(e=>e.value===o),m=t._filterOperationDescriptions.filter(e=>e.value===l.data[1]&&e.custom),p=0<c.length?c[0]:null,_=d.lookup&&d.lookup.dataSource?"lookup":p.dataType;2===r&&0!==m.length&&m[0].editorTemplate?(t._selectedCustomCondition=m[0],t._openCustomEditor(_,s,d)):t._openEditorByFieldType(_,s,d,n),t._editor.classList.remove("smart-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),i.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh(),d.lookup&&d.lookup.readonly&&t._editor.open()}_getFilterOperations(e){const t=this;let a=t._filterOperationDescriptions.slice();if(e.filterOperations)a=t._filterOperationDescriptions.filter(t=>-1<e.filterOperations.indexOf(t.value));else{let i;switch(e.dataType){case"date":case"datetime":case"number":i=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":i=["=","<>","isblank","isnotblank"];break;case"object":i=["isblank","isnotblank"];break;case"string":i=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:i=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"];}a=t._filterOperationDescriptions.filter(e=>-1<i.indexOf(e.value))}return t.showIcons&&a.map(e=>e.icon=t.icons[e.value]),a}_openCustomEditor(e,t,a){const i=this,l=i.customOperations[i._selectedCustomCondition.index].editorTemplate(e,t,a);i.$.customEditor.innerHTML="",l&&i.$.customEditor.appendChild(l),i._editor=i.$.customEditor}_openEditorByFieldType(e,t,a,i){const l=this;switch(e){case"boolean":l._initializeEditor("checkBox"),l._editor.checked=!!t;break;case"date":case"datetime":l._initializeEditor("dateTimePicker"),l._editor.formatString="date"===e?l.formatStringDate:l.formatStringDateTime,l._editor.value=t;break;case"number":l._initializeEditor("numericTextBox"),l._editor.value=t?t:0;break;default:l._initializeEditor("input"),l._editor.dropDownWidth=l.dropDownWidth,"lookup"===e?(l._editor.dataSource=a.lookup.dataSource,l._editor.dropDownAppendTo=l.$.container,l._editor.dropDownButtonPosition="right",l._editor.readonly=!!a.lookup.readonly):(l._editor.dataSource=[],l._editor.dropDownButtonPosition="none",l._editor.readonly=!1),"object"===e?l._editor.value=JSON.stringify(t?t:{}):(""===t&&l._editor.readonly&&(t=a.lookup.dataSource[0].label||""),l._editor.value=t+"",i&&(l._editor.$.input.dataValue=i));}}_initializeEditor(e){const t=this;if(t.$[e+"Editor"])return void(t._editor=t.$[e+"Editor"]);const a=document.createElement("smart-"+Smart.Utilities.Core.toDash(e));"numericTextBox"===e?(a.spinButtons=!0,a.inputFormat="floatingPoint"):"dateTimePicker"==e&&(a.dropDownAppendTo=t.$.container,a.calendarButton=!0,a.dropDownDisplayMode="auto",a.enableMouseWheelAction=!0,a.locale=t.locale,!a.messages[t.locale]&&(a.messages[t.locale]={}),a.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),a.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),a.theme=t.theme,a.animation=t.animation,a.$.addClass("smart-hidden underlined"),t.$.editorsContainer.appendChild(a),t._editor=t.$[e+"Editor"]=a}_getValidValue(){const e=this,t=e.properties.value.value,a=[];let i=!1;return t.forEach(t=>{if(Array.isArray(t)){let l=!1,o=!1;const n=[];t.forEach(t=>{if(Array.isArray(t)){const a=t[0],i=t[1],r=t[2];if(void 0===a||void 0===i)return void(o=!0);if(void 0!==r||"isblank"===i||"isnotblank"===i)return l=!0,void n.push(t);const d=e._filterOperationDescriptions.find(e=>e.value===i);d.custom&&d.hideValue?(l=!0,n.push(t)):o=!0}else o?o=!1:n.push(t)}),l?("string"==typeof n[n.length-1]&&n.pop(),a.push(n)):i=!0}else i?i=!1:a.push(t)}),"string"==typeof a[a.length-1]&&a.pop(),a}});